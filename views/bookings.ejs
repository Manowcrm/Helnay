<h1 class="mb-4">Make a Booking</h1>

<% if (selectedListingId) { %>
  <% const selectedListing = listings.find(l => l.id === parseInt(selectedListingId)); %>
  <% if (selectedListing) { %>
    <!-- Property Selected - Show as Card -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body p-4">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h4 class="mb-2">
              <i class="bi bi-house-door-fill text-primary me-2"></i>
              <%= selectedListing.title %>
            </h4>
            <p class="text-muted mb-2">
              <i class="bi bi-geo-alt-fill me-1"></i> <%= selectedListing.location %>
            </p>
            <span class="badge bg-success" style="font-size: 1rem; padding: 0.5rem 1rem;">
              <i class="bi bi-tag-fill me-1"></i> $<%= selectedListing.price %> per night
            </span>
          </div>
          <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <a href="/bookings" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-2"></i> Choose Different Property
            </a>
          </div>
        </div>
      </div>
    </div>
  <% } %>
<% } %>

<form method="POST" class="row g-3">
  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
  <% if (selectedListingId) { %>
    <!-- Hidden field when property is pre-selected -->
    <input type="hidden" name="listing_id" id="listing_id_hidden" value="<%= selectedListingId %>" />
  <% } else { %>
    <!-- Show dropdown when no property selected -->
    <div class="col-12">
      <label class="form-label fw-bold">Select Property</label>
      <select name="listing_id" class="form-select form-select-lg" id="listing_select" required>
        <option value="">-- Choose a property to book --</option>
        <% listings.forEach(function(l){ %>
          <option value="<%= l.id %>" data-price="<%= l.price %>" data-title="<%= l.title %>" data-location="<%= l.location %>">
            <%= l.title %> - $<%= l.price %>/night (<%= l.location %>)
          </option>
        <% }) %>
      </select>
    </div>
  <% } %>
  
  <div class="col-md-6">
    <label class="form-label fw-bold">Your name</label>
    <input name="name" class="form-control" placeholder="Enter your full name" required />
  </div>
  <div class="col-md-6">
    <label class="form-label fw-bold">Email</label>
    <input name="email" type="email" class="form-control" placeholder="your@email.com" required />
  </div>
  <div class="col-md-6">
    <label class="form-label fw-bold">Check-in Date</label>
    <input name="checkin_date" type="date" class="form-control" id="checkin_date" required />
  </div>
  <div class="col-md-6">
    <label class="form-label fw-bold">Check-in Time</label>
    <input name="checkin_time" type="time" class="form-control" id="checkin_time" value="15:00" required />
  </div>
  <div class="col-md-6">
    <label class="form-label fw-bold">Check-out Date</label>
    <input name="checkout_date" type="date" class="form-control" id="checkout_date" required />
  </div>
  <div class="col-md-6">
    <label class="form-label fw-bold">Check-out Time</label>
    <input name="checkout_time" type="time" class="form-control" id="checkout_time" value="11:00" required />
  </div>
  
  <!-- Booking Summary Card -->
  <div class="col-12">
    <div class="card bg-light border-0 shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3"><i class="bi bi-calculator"></i> Booking Summary</h5>
        <div id="booking_summary">
          <p class="text-muted"><small>Select dates to see the total cost</small></p>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Set minimum dates and times for booking
    const checkinDateInput = document.getElementById('checkin_date');
    const checkinTimeInput = document.getElementById('checkin_time');
    const checkoutDateInput = document.getElementById('checkout_date');
    const checkoutTimeInput = document.getElementById('checkout_time');
    const listingSelect = document.getElementById('listing_select');
    const listingHidden = document.getElementById('listing_id_hidden');
    const bookingSummary = document.getElementById('booking_summary');
    
    // Check if property is pre-selected
    const isPropertyPreSelected = listingHidden !== null;
    
    // Get current date and time
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const currentTime = now.toTimeString().slice(0, 5);
    
    // Set minimum check-in date to today
    checkinDateInput.min = today;
    
    // Validate check-in date and time
    checkinDateInput.addEventListener('change', function() {
      const selectedDate = this.value;
      
      // If today is selected, check-in time must be in the future
      if (selectedDate === today) {
        checkinTimeInput.min = currentTime;
        
        // If current time value is in the past, reset to current time
        if (checkinTimeInput.value < currentTime) {
          checkinTimeInput.value = currentTime;
        }
      } else {
        // For future dates, allow any time
        checkinTimeInput.removeAttribute('min');
      }
      
      // Set minimum checkout date to same as check-in date
      checkoutDateInput.min = selectedDate;
      
      // If checkout date is before check-in, update it
      if (checkoutDateInput.value && checkoutDateInput.value < selectedDate) {
        checkoutDateInput.value = selectedDate;
      }
    });
    
    // Validate check-in time when changed
    checkinTimeInput.addEventListener('change', function() {
      const selectedDate = checkinDateInput.value;
      
      // If today and time is in the past, reset to current time
      if (selectedDate === today && this.value < currentTime) {
        alert('Check-in time cannot be in the past. Please select a future time.');
        this.value = currentTime;
      }
    });
    
    // Validate checkout date
    checkoutDateInput.addEventListener('change', function() {
      const checkinDate = checkinDateInput.value;
      const checkoutDate = this.value;
      
      // Checkout must be same day or after check-in
      if (checkoutDate < checkinDate) {
        alert('Check-out date cannot be before check-in date.');
        this.value = checkinDate;
      }
      
      // If checkout is same day as check-in, validate time
      if (checkinDate && checkoutDate === checkinDate) {
        const checkinTime = checkinTimeInput.value;
        checkoutTimeInput.min = checkinTime;
        
        if (checkoutTimeInput.value <= checkinTime) {
          alert('Check-out time must be after check-in time on the same day.');
          // Set checkout time to 2 hours after check-in
          const [hours, minutes] = checkinTime.split(':');
          const newHours = (parseInt(hours) + 2) % 24;
          checkoutTimeInput.value = `${newHours.toString().padStart(2, '0')}:${minutes}`;
        }
      } else {
        // Different days, remove time restriction
        checkoutTimeInput.removeAttribute('min');
      }
    });
    
    // Validate checkout time
    checkoutTimeInput.addEventListener('change', function() {
      const checkinDate = checkinDateInput.value;
      const checkoutDate = checkoutDateInput.value;
      
      // If same day, checkout time must be after check-in time
      if (checkinDate && checkoutDate && checkinDate === checkoutDate) {
        const checkinTime = checkinTimeInput.value;
        if (this.value <= checkinTime) {
          alert('Check-out time must be after check-in time on the same day.');
          // Set to 2 hours after check-in
          const [hours, minutes] = checkinTime.split(':');
          const newHours = (parseInt(hours) + 2) % 24;
          this.value = `${newHours.toString().padStart(2, '0')}:${minutes}`;
        }
      }
    });
    
    // Initialize: trigger check-in date validation
    checkinDateInput.dispatchEvent(new Event('change'));
    
    // Calculate booking cost
    function calculateBookingCost() {
      const checkinDate = checkinDateInput.value;
      const checkoutDate = checkoutDateInput.value;
      
      let pricePerNight, listingTitle, listingLocation;
      
      if (isPropertyPreSelected) {
        // Get data from the page (pre-selected property)
        <% if (selectedListingId) { %>
          <% const selectedListing = listings.find(l => l.id === parseInt(selectedListingId)); %>
          <% if (selectedListing) { %>
            pricePerNight = <%= selectedListing.price %>;
            listingTitle = "<%= selectedListing.title %>";
            listingLocation = "<%= selectedListing.location %>";
          <% } %>
        <% } %>
      } else {
        // Get data from dropdown
        if (!listingSelect || !listingSelect.value) {
          bookingSummary.innerHTML = '<p class="text-muted mb-0"><small><i class="bi bi-arrow-up"></i> Please select a property above</small></p>';
          return;
        }
        const selectedOption = listingSelect.options[listingSelect.selectedIndex];
        pricePerNight = parseFloat(selectedOption.getAttribute('data-price'));
        listingTitle = selectedOption.getAttribute('data-title');
        listingLocation = selectedOption.getAttribute('data-location');
      }
      
      if (checkinDate && checkoutDate && pricePerNight) {
        // Calculate number of nights
        const checkin = new Date(checkinDate);
        const checkout = new Date(checkoutDate);
        const diffTime = Math.abs(checkout - checkin);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const nights = diffDays || 1; // Minimum 1 night
        
        const totalCost = nights * pricePerNight;
        
        // Update summary
        bookingSummary.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <p class="mb-2"><strong><i class="bi bi-building"></i> Property:</strong> ${listingTitle}</p>
              <p class="mb-2"><small class="text-muted"><i class="bi bi-geo-alt"></i> ${listingLocation}</small></p>
            </div>
            <div class="col-md-6 text-md-end">
              <p class="mb-2"><strong><i class="bi bi-moon"></i> Nights:</strong> ${nights}</p>
              <p class="mb-2"><strong><i class="bi bi-tag"></i> Price per night:</strong> $${pricePerNight}</p>
            </div>
          </div>
          <hr class="my-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Total Cost:</h5>
            <h4 class="mb-0 text-primary">$${totalCost.toFixed(2)}</h4>
          </div>
          <small class="text-muted d-block mt-2">
            <i class="bi bi-info-circle"></i> Payment will be processed after confirmation
          </small>
        `;
      } else {
        bookingSummary.innerHTML = '<p class="text-muted mb-0"><small>Select dates to see the total cost</small></p>';
      }
    }
    
    // Add event listeners for cost calculation
    checkinDateInput.addEventListener('change', calculateBookingCost);
    checkoutDateInput.addEventListener('change', calculateBookingCost);
    
    // Only add listener to dropdown if it exists
    if (listingSelect) {
      listingSelect.addEventListener('change', calculateBookingCost);
    }
    
    // Initial calculation if property is pre-selected
    if (isPropertyPreSelected) {
      calculateBookingCost();
    }
  </script>
  <div class="col-12">
    <button class="btn btn-primary btn-lg w-100 py-3">
      <i class="bi bi-check-circle me-2"></i> Confirm Booking
    </button>
  </div>
</form>
