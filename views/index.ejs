<div class="hero-banner">
  <div class="hero-overlay">
    <div class="container">
      <div class="hero-content text-center text-white">
        <h1 class="display-4 fw-bold mb-3">Find Your Perfect Stay</h1>
        <p class="lead mb-4">Discover amazing homes and experiences around the world</p>
        <form method="GET" action="/" class="search-box-large mx-auto">
          <div class="row g-2">
            <div class="col-md-5">
              <input name="q" class="form-control" placeholder="Search destination or property" value="<%= (typeof query !== 'undefined' && query.q) ? query.q : '' %>">
            </div>
            <div class="col-md-3">
              <input name="location" class="form-control" placeholder="Location" value="<%= (typeof query !== 'undefined' && query.location) ? query.location : '' %>">
            </div>
            <div class="col-md-2">
              <input name="min_price" class="form-control" placeholder="Min Price" type="number" min="0" value="<%= (typeof query !== 'undefined' && query.min_price) ? query.min_price : '' %>">
            </div>
            <div class="col-md-2 d-grid">
              <button type="submit" class="btn btn-warning"><i class="bi bi-search"></i> Search</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="container mt-4">
  <div class="row">
    <!-- Sidebar Filters -->
    <div class="col-lg-3 mb-4">
      <div class="sidebar-filters">
        <!-- Booking Options -->
        <div class="filter-section">
          <h6 class="filter-title">Booking Options</h6>
          <div class="filter-options">
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="instant">
              <span>Instant Booking</span>
            </label>
          </div>
        </div>

        <!-- Services -->
        <div class="filter-section">
          <h6 class="filter-title">Services</h6>
          <div class="filter-options">
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="pool">
              <span><i class="bi bi-water"></i> Pool</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="wifi">
              <span><i class="bi bi-wifi"></i> WiFi</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="balcony">
              <span><i class="bi bi-building"></i> Balcony/Patio</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="ac">
              <span><i class="bi bi-snow"></i> Air Conditioning</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="garden">
              <span><i class="bi bi-flower1"></i> Garden</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="tv">
              <span><i class="bi bi-tv"></i> TV</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="parking">
              <span><i class="bi bi-car-front"></i> Parking</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="kitchen">
              <span><i class="bi bi-cup-hot"></i> Kitchen</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="washer">
              <span><i class="bi bi-recycle"></i> Washing Machine</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="microwave">
              <span><i class="bi bi-lightning"></i> Microwave</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="dishwasher">
              <span><i class="bi bi-droplet"></i> Dishwasher</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="hottub">
              <span><i class="bi bi-tsunami"></i> Hot Tub</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="sauna">
              <span><i class="bi bi-fire"></i> Sauna</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="fireplace">
              <span><i class="bi bi-fire"></i> Fireplace</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="cot">
              <span><i class="bi bi-moon"></i> Cot</span>
            </label>
          </div>
        </div>

        <!-- Accommodation Type -->
        <div class="filter-section">
          <h6 class="filter-title">Accommodation Type</h6>
          <div class="filter-options">
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="pet-friendly">
              <span><i class="bi bi-heart"></i> Pet-friendly</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="no-smoking">
              <span><i class="bi bi-slash-circle"></i> No Smoking</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="no-pets">
              <span><i class="bi bi-x-circle"></i> No Pets</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="wheelchair">
              <span><i class="bi bi-person-wheelchair"></i> Wheelchair Access</span>
            </label>
          </div>
        </div>

        <!-- Activities -->
        <div class="filter-section">
          <h6 class="filter-title">Activities</h6>
          <div class="filter-options">
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="fishing">
              <span><i class="bi bi-life-preserver"></i> Fishing</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="grill">
              <span><i class="bi bi-fire"></i> Grill</span>
            </label>
          </div>
        </div>

        <!-- Quick Categories -->
        <div class="filter-section">
          <h6 class="filter-title">Browse by Category</h6>
          <div class="category-links">
            <a href="/entire-homes" class="category-link">
              <i class="bi bi-house-door"></i> Entire Homes
            </a>
            <a href="/city-stays" class="category-link">
              <i class="bi bi-building"></i> City Stays
            </a>
            <a href="/beach-houses" class="category-link">
              <i class="bi bi-water"></i> Beach Houses
            </a>
            <a href="/mountain-retreats" class="category-link">
              <i class="bi bi-tree"></i> Mountain Retreats
            </a>
          </div>
        </div>

        <!-- Price Range -->
        <div class="filter-section">
          <h6 class="filter-title">Price Range</h6>
          <div class="price-inputs">
            <input type="number" class="form-control form-control-sm mb-2" placeholder="Min $" id="priceMin">
            <input type="number" class="form-control form-control-sm" placeholder="Max $" id="priceMax">
            <button class="btn btn-sm btn-primary w-100 mt-2" onclick="applyPriceFilter()">Apply</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9">

      <h2 class="mb-4">Available Properties <span class="badge bg-secondary listings-count"><%= listings.length %></span></h2>
      <div class="row" id="listingsContainer">
  <% if (!listings || listings.length === 0) { %>
    <div class="col-12"><p>No listings found.</p></div>
  <% } %>
  <% listings.forEach(function(l){ %>
    <div class="col-md-4 mb-4">
      <div class="card listing-card h-100">
        <% if (l.image_url) { %>
          <div class="listing-img-wrapper">
            <img src="<%= l.image_url %>" class="card-img-top" alt="<%= l.title %>">
            <span class="badge badge-location"><i class="bi bi-geo-alt"></i> <%= l.location %></span>
          </div>
        <% } %>
        <div class="card-body d-flex flex-column">
          <h5 class="card-title"><%= l.title %></h5>
          <p class="card-text text-muted small mb-2">
            <i class="bi bi-house"></i> Available for rent
          </p>
          <p class="card-text"><%= l.description.length > 100 ? l.description.substring(0,100) + '...' : l.description %></p>
          <div class="mt-auto">
            <hr>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong class="text-primary fs-5">$<%= l.price %></strong>
                <small class="text-muted">/night</small>
              </div>
              <a href="/listings/<%= l.id %>" class="btn btn-primary">Rent Now</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% }) %>
      </div>

      <!-- Featured Rentals Section -->
  <div class="row mt-5 pt-4 border-top">
    <div class="col-12 mb-4">
      <h3>More Properties Available for Rent</h3>
      <p class="text-muted">Explore additional rental options in different locations</p>
    </div>
    <% 
    const featuredRentals = [
      { title: 'Luxury Penthouse', location: 'Manhattan', price: 450, type: 'apartment', image: 'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=800&q=80' },
      { title: 'Lakeside Villa', location: 'Lake District', price: 320, type: 'villa', image: 'https://images.unsplash.com/photo-1613490493576-7fde63acd811?w=800&q=80' },
      { title: 'Desert Oasis Home', location: 'Arizona', price: 195, type: 'home', image: 'https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?w=800&q=80' },
      { title: 'Tropical Beach Villa', location: 'Miami Beach', price: 380, type: 'villa', image: 'https://images.unsplash.com/photo-1499793983690-e29da59ef1c2?w=800&q=80' },
      { title: 'Downtown Studio', location: 'Chicago', price: 75, type: 'studio', image: 'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=800&q=80' },
      { title: 'Mountain View Chalet', location: 'Swiss Alps', price: 280, type: 'chalet', image: 'https://images.unsplash.com/photo-1518780664697-55e3ad937233?w=800&q=80' },
      { title: 'Historic Townhouse', location: 'Boston', price: 225, type: 'townhouse', image: 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=800&q=80' },
      { title: 'Waterfront Condo', location: 'Seattle', price: 165, type: 'condo', image: 'https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=800&q=80' },
      { title: 'Country Farmhouse', location: 'Vermont', price: 140, type: 'farmhouse', image: 'https://images.unsplash.com/photo-1596721853750-2f8e8c39e826?w=800&q=80' },
      { title: 'Urban Loft Space', location: 'Brooklyn', price: 190, type: 'loft', image: 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800&q=80' }
    ];
    %>
    <% featuredRentals.forEach(function(rental, idx){ %>
      <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <div class="card featured-rental-card h-100">
          <div class="featured-img-wrapper">
            <img src="<%= rental.image %>" class="card-img-top" alt="<%= rental.title %>">
            <span class="badge badge-featured">Featured</span>
          </div>
          <div class="card-body">
            <h6 class="card-title"><%= rental.title %></h6>
            <p class="card-text text-muted small mb-2">
              <i class="bi bi-geo-alt-fill"></i> <%= rental.location %>
            </p>
            <div class="d-flex justify-content-between align-items-center">
              <span><strong class="text-primary">$<%= rental.price %></strong><small class="text-muted">/night</small></span>
              <a href="/?location=<%= rental.location %>&type=<%= rental.type %>" class="btn btn-sm btn-outline-primary">View</a>
            </div>
          </div>
        </div>
      </div>
    <% }) %>
      </div>
    </div>
  </div>
</div>

<script>
// Filter functionality
const filterInputs = document.querySelectorAll('.filter-input');
const listingsContainer = document.getElementById('listingsContainer');
const allListings = Array.from(listingsContainer.children);

// Store original display state
allListings.forEach(listing => {
  listing.dataset.originalDisplay = listing.style.display || 'block';
});

filterInputs.forEach(input => {
  input.addEventListener('change', applyFilters);
});

function applyFilters() {
  const activeFilters = Array.from(document.querySelectorAll('.filter-input:checked')).map(cb => cb.dataset.filter);
  
  // Get price filters
  const minPrice = parseFloat(document.getElementById('priceMin')?.value) || 0;
  const maxPrice = parseFloat(document.getElementById('priceMax')?.value) || Infinity;
  
  allListings.forEach(listing => {
    const listingText = listing.textContent.toLowerCase();
    const description = listing.querySelector('.card-text')?.textContent.toLowerCase() || '';
    const title = listing.querySelector('.card-title')?.textContent.toLowerCase() || '';
    const fullText = title + ' ' + description;
    
    // Check price
    const priceText = listing.querySelector('.text-primary')?.textContent || '';
    const price = parseFloat(priceText.replace(/[^0-9.]/g, ''));
    const priceMatch = price >= minPrice && price <= maxPrice;
    
    // If no filters selected, show all (that match price)
    if (activeFilters.length === 0) {
      listing.style.display = priceMatch ? '' : 'none';
      return;
    }
    
    // Check if listing matches ALL selected filters (AND logic)
    const matches = activeFilters.every(filter => {
      switch(filter) {
        case 'pool': return fullText.includes('pool');
        case 'wifi': return fullText.includes('wifi') || fullText.includes('wi-fi') || fullText.includes('internet');
        case 'balcony': return fullText.includes('balcony') || fullText.includes('patio') || fullText.includes('terrace') || fullText.includes('deck');
        case 'ac': return fullText.includes('air condition') || fullText.includes('ac ') || fullText.includes('cooling');
        case 'garden': return fullText.includes('garden') || fullText.includes('yard');
        case 'tv': return fullText.includes('tv') || fullText.includes('television') || fullText.includes('smart tv');
        case 'parking': return fullText.includes('parking') || fullText.includes('garage');
        case 'kitchen': return fullText.includes('kitchen') || fullText.includes('full kitchen');
        case 'washer': return fullText.includes('washing') || fullText.includes('laundry') || fullText.includes('washer');
        case 'microwave': return fullText.includes('microwave');
        case 'dishwasher': return fullText.includes('dishwasher');
        case 'hottub': return fullText.includes('hot tub') || fullText.includes('jacuzzi') || fullText.includes('spa');
        case 'sauna': return fullText.includes('sauna');
        case 'fireplace': return fullText.includes('fireplace') || fullText.includes('wood stove');
        case 'cot': return fullText.includes('cot') || fullText.includes('crib') || fullText.includes('baby bed');
        case 'pet-friendly': return (fullText.includes('pet') && fullText.includes('friend')) || fullText.includes('pet-friend') || fullText.includes('pets welcome');
        case 'no-smoking': return fullText.includes('no smoking') || fullText.includes('non-smoking') || fullText.includes('smoke-free');
        case 'no-pets': return fullText.includes('no pet');
        case 'wheelchair': return fullText.includes('wheelchair') || fullText.includes('accessible') || fullText.includes('disability');
        case 'fishing': return fullText.includes('fishing') || fullText.includes('fish');
        case 'grill': return fullText.includes('grill') || fullText.includes('bbq') || fullText.includes('barbecue');
        case 'instant': return true; // All properties available for instant booking
        default: return true;
      }
    });
    
    // Show only if matches ALL filters AND price range
    listing.style.display = (matches && priceMatch) ? '' : 'none';
  });
  
  updateListingsCount();
}

function applyPriceFilter() {
  // Just trigger the main filter function which now handles price
  applyFilters();
}

function updateListingsCount() {
  const visibleCount = allListings.filter(l => l.style.display !== 'none').length;
  const countBadge = document.querySelector('.listings-count');
  if (countBadge) {
    countBadge.textContent = visibleCount;
  }
}
</script>
