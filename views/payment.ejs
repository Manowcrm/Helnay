<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0"><i class="bi bi-credit-card"></i> Complete Your Payment</h3>
        </div>
        <div class="card-body p-4">
          <!-- Booking Summary -->
          <div class="alert alert-info">
            <h5 class="alert-heading"><i class="bi bi-info-circle"></i> Booking Summary</h5>
            <hr>
            <div class="row">
              <div class="col-md-6">
                <p><strong>Property:</strong> <%= booking.title %></p>
                <p><strong>Location:</strong> <%= booking.location %></p>
                <p><strong>Guest:</strong> <%= booking.name %></p>
              </div>
              <div class="col-md-6">
                <p><strong>Check-in:</strong> <%= new Date(booking.checkin).toLocaleString() %></p>
                <p><strong>Check-out:</strong> <%= new Date(booking.checkout).toLocaleString() %></p>
                <p><strong>Nights:</strong> <%= nights %></p>
              </div>
            </div>
          </div>

          <!-- Payment Details -->
          <div class="card bg-light mb-4">
            <div class="card-body">
              <h5 class="card-title">Payment Details</h5>
              <div class="d-flex justify-content-between">
                <span>$<%= booking.price.toFixed(2) %> Ã— <%= nights %> night<%= nights > 1 ? 's' : '' %></span>
                <strong>$<%= booking.total_amount.toFixed(2) %></strong>
              </div>
              <hr>
              <div class="d-flex justify-content-between">
                <h5 class="mb-0">Total Amount</h5>
                <h4 class="mb-0 text-primary">$<%= booking.total_amount.toFixed(2) %></h4>
              </div>
            </div>
          </div>

          <!-- Stripe Payment Form -->
          <% if (stripePublishableKey) { %>
          <form id="payment-form">
            <div class="mb-3">
              <label class="form-label">Card Information</label>
              <div id="card-element" class="form-control" style="height: 40px; padding: 10px;"></div>
              <div id="card-errors" class="text-danger mt-2"></div>
            </div>

            <button id="submit-button" class="btn btn-primary btn-lg w-100" type="submit">
              <span id="button-text">
                <i class="bi bi-lock-fill"></i> Pay $<%= booking.total_amount.toFixed(2) %>
              </span>
              <div id="spinner" class="spinner-border spinner-border-sm d-none" role="status">
                <span class="visually-hidden">Processing...</span>
              </div>
            </button>

            <p class="text-center text-muted mt-3 mb-0">
              <i class="bi bi-shield-check"></i> Your payment information is secure and encrypted
            </p>
          </form>

          <script src="https://js.stripe.com/v3/"></script>
          <script>
            const stripe = Stripe('<%= stripePublishableKey %>');
            const elements = stripe.elements();
            const cardElement = elements.create('card', {
              style: {
                base: {
                  fontSize: '16px',
                  color: '#32325d',
                  fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                  '::placeholder': {
                    color: '#aab7c4'
                  }
                }
              }
            });
            cardElement.mount('#card-element');

            cardElement.on('change', function(event) {
              const displayError = document.getElementById('card-errors');
              if (event.error) {
                displayError.textContent = event.error.message;
              } else {
                displayError.textContent = '';
              }
            });

            const form = document.getElementById('payment-form');
            const submitButton = document.getElementById('submit-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');

            form.addEventListener('submit', async function(event) {
              event.preventDefault();
              
              // Disable button and show spinner
              submitButton.disabled = true;
              buttonText.classList.add('d-none');
              spinner.classList.remove('d-none');

              try {
                // Create payment intent
                const response = await fetch('/create-payment-intent', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    bookingId: '<%= booking.id %>'
                  })
                });

                const { clientSecret, error } = await response.json();

                if (error) {
                  throw new Error(error);
                }

                // Confirm the payment
                const result = await stripe.confirmCardPayment(clientSecret, {
                  payment_method: {
                    card: cardElement,
                    billing_details: {
                      name: '<%= booking.name %>',
                      email: '<%= booking.email %>'
                    }
                  }
                });

                if (result.error) {
                  // Show error to customer
                  document.getElementById('card-errors').textContent = result.error.message;
                  submitButton.disabled = false;
                  buttonText.classList.remove('d-none');
                  spinner.classList.add('d-none');
                } else {
                  // Payment succeeded
                  if (result.paymentIntent.status === 'succeeded') {
                    // Update booking status
                    await fetch('/create-payment-intent', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({
                        bookingId: '<%= booking.id %>',
                        paymentIntentId: result.paymentIntent.id
                      })
                    });
                    
                    // Redirect to success page
                    window.location.href = '/payment/success?booking_id=<%= booking.id %>';
                  }
                }
              } catch (err) {
                document.getElementById('card-errors').textContent = err.message;
                submitButton.disabled = false;
                buttonText.classList.remove('d-none');
                spinner.classList.add('d-none');
              }
            });
          </script>
          <% } else { %>
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> Payment system is not configured. Please contact the administrator.
          </div>
          <% } %>
        </div>
      </div>

      <!-- Security Information -->
      <div class="text-center mt-4">
        <p class="text-muted">
          <i class="bi bi-shield-fill-check text-success"></i> Secured by Stripe<br>
          <small>We never store your card details</small>
        </p>
      </div>
    </div>
  </div>
</div>
